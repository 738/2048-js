for(var width=4,height=4,score=0,isPlaying=0,zeroColor="rgb(255,230,220)",colorArr=["rgb(255,210,200)","rgb(230,240,100)","rgb(255,170,140)","rgb(100,240,175)","rgb(255,215,100)","rgb(120,255,90)","rgb(100,250,225)","rgb(180,250,0)","rgb(175,255,140)","rgb(135,255,85)","rgb(130,250,240)","rgb(35,200,255)","rgb(250,190,255)","rgb(245,128,255)","rgb(190,150,220)","rgb(170,60,230)"],main_map=document.getElementById("main_map"),row=new Array(height),cell=new Array(height),i=0;i<height;i++)cell[i]=new Array(width);for(i=0;i<height;i++){row[i]=main_map.insertRow(-1);for(var j=0;j<width;j++)cell[i][j]=row[i].insertCell(j),cell[i][j].setAttribute("id","td"+i+"_"+j)}var tdArr=new Array(height);for(i=0;i<height;i++)tdArr[i]=new Array(width);for(i=0;i<height;i++)for(j=0;j<width;j++)tdArr[i][j]=document.getElementById("td"+i+"_"+j);var main_arr=new Array(height);for(i=0;i<height;i++)main_arr[i]=[0,0,0,0];function renewTable(){for(var r=0;r<height;r++)for(var e=0;e<width;e++){var i=document.getElementById("td"+r+"_"+e);if(0!=main_arr[r][e]){var t=main_arr[r][e];i.innerHTML=t,i.style.backgroundColor=colorArr[log(t,2)-1],i.style.fontSize="30px",t>=1e4?i.style.fontSize="20px":t>=1e3&&(i.style.fontSize="25px")}else i.innerHTML="",i.style.backgroundColor=zeroColor,i.style.fontSize="30px"}renewScore()}function renewScore(){document.getElementById("score").innerHTML=score}function createRand(r){for(var e=Math.floor(4*Math.random()),i=Math.floor(4*Math.random()),t=main_arr[e][i];t;){if(isFull())return;e=Math.floor(4*Math.random()),i=Math.floor(4*Math.random());t=main_arr[e][i]}var n=Math.floor(Math.random()*r.length);main_arr[e][i]=r[n],renewTable()}function gameStart(){isPlaying=1,createRand([2]),createRand([2])}function zeroPush(r){var e=r.length;if(4!=e)return alert("¿À·ù! -zeroPush"),!1;for(var i=e-1;i>=0;i--)for(var t=e-1;t>=e-i;t--)if(0==r[t]){var n=r[t];r[t]=r[t-1],r[t-1]=n}return r}function plusPush(r){var e=r.length;if(4!=e)return alert("¿À·ù! -plusPush"),!1;for(var i=[],t=0;t<4;t++)i[t]=r[t];zeroPush(r);for(t=e-1;t>0;t--)0!=r[t]&&r[t]==r[t-1]&&(r[t]=r[t]+r[t-1],r[t-1]=0,zeroPush(r),score+=r[t]);for(t=0;t<4;t++)if(i[t]!=r[t])return!0;return!1}function goDown(){for(var r=new Array(width),e=new Array(width),i=0;i<width;i++)r[i]=new Array(height);for(i=0;i<width;i++){for(var t=0;t<height;t++)r[i][t]=main_arr[t][i];e[i]=plusPush(r[i]);for(t=0;t<height;t++)main_arr[t][i]=r[i][t]}var n=0;for(i=0;i<width;i++)e[i]||n++;n<width&&createRand([2,2,2,4]),checkOver()}function goUp(){for(var r=new Array(width),e=new Array(width),i=0;i<width;i++)r[i]=new Array(height);for(i=0;i<width;i++){for(var t=height-1;t>=0;t--)r[i][height-t-1]=main_arr[t][i];e[i]=plusPush(r[i]);for(t=height-1;t>=0;t--)main_arr[height-t-1][i]=r[i][t]}var n=0;for(i=0;i<width;i++)e[i]||n++;n<width&&createRand([2,2,2,4]),checkOver()}function goRight(){for(var r=new Array(height),e=new Array(height),i=0;i<height;i++)r[i]=new Array(width);for(i=0;i<height;i++){for(var t=0;t<width;t++)r[i][t]=main_arr[i][t];e[i]=plusPush(r[i]);for(t=0;t<width;t++)main_arr[i][t]=r[i][t]}var n=0;for(i=0;i<height;i++)e[i]||n++;n<height&&createRand([2,2,2,4]),checkOver()}function goLeft(){for(var r=new Array(height),e=new Array(height),i=0;i<height;i++)r[i]=new Array(width);for(i=0;i<height;i++){for(var t=width-1;t>=0;t--)r[i][width-t-1]=main_arr[i][t];e[i]=plusPush(r[i]);for(t=width-1;t>=0;t--)main_arr[i][width-t-1]=r[i][t]}var n=0;for(i=0;i<height;i++)e[i]||n++;n<height&&createRand([2,2,2,4]),checkOver()}function isOver(){for(var r=0;r<height;r++)for(j=0;j<width;j++)if(0==main_arr[r][j])return!1;for(r=0;r<height;r++)for(j=0;j<width-1;j++)if(main_arr[r][j]==main_arr[r][j+1])return!1;for(r=0;r<width;r++)for(j=0;j<height-1;j++)if(main_arr[j][r]==main_arr[j+1][r])return!1;return!0}function checkOver(){isOver()&&isPlaying&&(isPlaying=0,alert("GAME OVER\nscore: "+score))}function isFull(){for(var r=0;r<height;r++)for(j=0;j<width;j++)if(0==main_arr[r][j])return!1;return!0}function log(r,e){var i=0;if(r%e)return alert("log function error"),!1;for(;1!=r;)r/=e,i++;return i}gameStart(),document.onkeydown=function(){37==event.keyCode?goLeft():38==event.keyCode?goUp():39==event.keyCode?goRight():40==event.keyCode&&goDown()};